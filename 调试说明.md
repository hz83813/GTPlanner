# ğŸ”§ å‰ç«¯è°ƒè¯•è¯´æ˜

## é—®é¢˜åˆ†æ

**é”™è¯¯**: `422 Unprocessable Entity`

**åŸå› **: å‰ç«¯å‘é€çš„è¯·æ±‚æ•°æ®æ ¼å¼ä¸ç¬¦åˆåç«¯ API çš„è¦æ±‚

### åŸå§‹é—®é¢˜

å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼ï¼š
```javascript
{
    user_input: "è®¾è®¡ä¸€ä¸ªåœ¨çº¿å•†åŸç³»ç»Ÿ",
    include_metadata: false,
    buffer_events: false,
    heartbeat_interval: 30
}
```

åç«¯æœŸæœ›çš„æ ¼å¼ï¼š
```javascript
{
    session_id: "session-xxx",          // å¿…éœ€å­—æ®µ
    dialogue_history: [...],            // å¿…éœ€å­—æ®µ
    tool_execution_results: {},        // å¯é€‰å­—æ®µ
    session_metadata: {...},           // å¯é€‰å­—æ®µ
    include_metadata: false,
    buffer_events: false,
    heartbeat_interval: 30
}
```

### è§£å†³æ–¹æ¡ˆ

å·²ä¿®å¤å‰ç«¯ä»£ç ï¼Œç°åœ¨ä¼šæ­£ç¡®å‘é€ï¼š
- âœ… `session_id` - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ä¼šè¯ ID
- âœ… `dialogue_history` - åŒ…å«ç”¨æˆ·æ¶ˆæ¯
- âœ… `tool_execution_results` - ç©ºå¯¹è±¡
- âœ… `session_metadata` - åŒ…å«è¯­è¨€è®¾ç½®

---

## âœ… å·²ä¿®å¤

**ä¿®æ”¹çš„æ–‡ä»¶**: `static/test_chat.html`

**æ”¹åŠ¨å†…å®¹**:
```javascript
// ç”Ÿæˆä¼šè¯ ID
const sessionId = `session-${Date.now()}`;

// å‡†å¤‡è¯·æ±‚æ•°æ®ï¼ˆç¬¦åˆåç«¯ API è¦æ±‚ï¼‰
const requestData = {
    session_id: sessionId,
    dialogue_history: [
        {
            role: "user",
            content: userInput
        }
    ],
    tool_execution_results: {},
    session_metadata: {
        language: "zh"
    },
    include_metadata: includeMetadata,
    buffer_events: bufferEvents,
    heartbeat_interval: 30
};
```

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°æµè§ˆå™¨é¡µé¢**
   ```
   http://localhost:11211/static/test_chat.html
   ```

2. **è¾“å…¥æµ‹è¯•éœ€æ±‚**
   ```
   è®¾è®¡ä¸€ä¸ªåœ¨çº¿å•†åŸç³»ç»Ÿ
   ```

3. **ç‚¹å‡»å‘é€è¯·æ±‚**

4. **æŸ¥çœ‹å“åº”**
   - åº”è¯¥èƒ½çœ‹åˆ°å®æ—¶æµå¼è¾“å‡º
   - ä¸å†å‡ºç° 422 é”™è¯¯

---

## ğŸ“Š API æ•°æ®ç»“æ„è¯´æ˜

### AgentContextRequest

åç«¯ API è¦æ±‚çš„å®Œæ•´æ•°æ®ç»“æ„ï¼š

```json
{
  "session_id": "session-1234567890",
  "dialogue_history": [
    {
      "role": "user",
      "content": "è®¾è®¡ä¸€ä¸ªåœ¨çº¿å•†åŸç³»ç»Ÿ"
    }
  ],
  "tool_execution_results": {},
  "session_metadata": {
    "language": "zh"
  },
  "last_updated": null,
  "is_compressed": false,
  "language": "zh",
  "include_metadata": false,
  "buffer_events": false,
  "heartbeat_interval": 30.0
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| session_id | string | âœ… | ä¼šè¯å”¯ä¸€æ ‡è¯†ç¬¦ |
| dialogue_history | array | âœ… | å¯¹è¯å†å²ï¼ŒåŒ…å«æ¶ˆæ¯æ•°ç»„ |
| tool_execution_results | object | âŒ | å·¥å…·æ‰§è¡Œç»“æœ |
| session_metadata | object | âŒ | ä¼šè¯å…ƒæ•°æ® |
| language | string | âŒ | è¯­è¨€è®¾ç½® (zh/en/ja/es/fr) |
| include_metadata | boolean | âŒ | æ˜¯å¦åŒ…å«å…ƒæ•°æ® |
| buffer_events | boolean | âŒ | æ˜¯å¦ç¼“å†²äº‹ä»¶ |
| heartbeat_interval | float | âŒ | å¿ƒè·³é—´éš”(ç§’) |

---

## ğŸ” éªŒè¯ä¿®å¤

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12):

1. **æŸ¥çœ‹è¯·æ±‚**
   - Network æ ‡ç­¾
   - æ‰¾åˆ° `/api/chat/agent` è¯·æ±‚
   - çŠ¶æ€ç åº”è¯¥æ˜¯ `200 OK` è€Œä¸æ˜¯ `422`

2. **æŸ¥çœ‹å“åº”**
   - åº”è¯¥èƒ½çœ‹åˆ° SSE äº‹ä»¶æµ
   - äº‹ä»¶ç±»å‹åŒ…æ‹¬: connection, message, tool_call, complete ç­‰

3. **æ£€æŸ¥æ§åˆ¶å°**
   - ä¸åº”è¯¥æœ‰é”™è¯¯ä¿¡æ¯
   - åº”è¯¥çœ‹åˆ°äº‹ä»¶æ—¥å¿—

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **éœ€è¦é…ç½® API Key**
   ```powershell
   $env:LLM_API_KEY="sk-your-key"
   $env:LLM_BASE_URL="https://api.openai.com/v1"
   $env:LLM_MODEL="gpt-4"
   ```

2. **æœåŠ¡å¿…é¡»è¿è¡Œ**
   - FastAPI æœåŠ¡åº”è¯¥åœ¨ http://localhost:11211
   - å¯ä»¥é€šè¿‡å¥åº·æ£€æŸ¥éªŒè¯

3. **æµè§ˆå™¨å…¼å®¹æ€§**
   - æ¨èä½¿ç”¨ Chromeã€Firefoxã€Edge
   - éœ€è¦æ”¯æŒ SSE (Server-Sent Events)

---

## ğŸ“ å…¶ä»–è°ƒè¯•ä¿¡æ¯

### æŸ¥çœ‹å®Œæ•´æ—¥å¿—

åœ¨ PowerShell ä¸­å¯ä»¥çœ‹åˆ°ï¼š
```
INFO:     127.0.0.1:xxxxx - "POST /api/chat/agent HTTP/1.1" 200 OK
```

å¦‚æœçœ‹åˆ° `422`ï¼Œè¯´æ˜è¿˜æœ‰æ ¼å¼é—®é¢˜ã€‚

### å¸¸è§é”™è¯¯

1. **ç¼ºå°‘å¿…éœ€å­—æ®µ**
   ```
   422 Unprocessable Entity
   ```
   è§£å†³: æ£€æŸ¥æ˜¯å¦åŒ…å« session_id å’Œ dialogue_history

2. **æ•°æ®ç±»å‹é”™è¯¯**
   ```
   422 Unprocessable Entity
   ```
   è§£å†³: æ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®

3. **API Key æœªé…ç½®**
   ```
   500 Internal Server Error
   ```
   è§£å†³: é…ç½®ç¯å¢ƒå˜é‡

---

## âœ… ä¿®å¤å®Œæˆ

å‰ç«¯è¯·æ±‚æ ¼å¼å·²ä¿®å¤ï¼Œç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼

**åˆ·æ–°é¡µé¢åé‡è¯•** ğŸš€

