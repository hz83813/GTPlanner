# 🔧 前端调试说明

## 问题分析

**错误**: `422 Unprocessable Entity`

**原因**: 前端发送的请求数据格式不符合后端 API 的要求

### 原始问题

前端发送的数据格式：
```javascript
{
    user_input: "设计一个在线商城系统",
    include_metadata: false,
    buffer_events: false,
    heartbeat_interval: 30
}
```

后端期望的格式：
```javascript
{
    session_id: "session-xxx",          // 必需字段
    dialogue_history: [...],            // 必需字段
    tool_execution_results: {},        // 可选字段
    session_metadata: {...},           // 可选字段
    include_metadata: false,
    buffer_events: false,
    heartbeat_interval: 30
}
```

### 解决方案

已修复前端代码，现在会正确发送：
- ✅ `session_id` - 自动生成唯一会话 ID
- ✅ `dialogue_history` - 包含用户消息
- ✅ `tool_execution_results` - 空对象
- ✅ `session_metadata` - 包含语言设置

---

## ✅ 已修复

**修改的文件**: `static/test_chat.html`

**改动内容**:
```javascript
// 生成会话 ID
const sessionId = `session-${Date.now()}`;

// 准备请求数据（符合后端 API 要求）
const requestData = {
    session_id: sessionId,
    dialogue_history: [
        {
            role: "user",
            content: userInput
        }
    ],
    tool_execution_results: {},
    session_metadata: {
        language: "zh"
    },
    include_metadata: includeMetadata,
    buffer_events: bufferEvents,
    heartbeat_interval: 30
};
```

---

## 🚀 测试步骤

1. **刷新浏览器页面**
   ```
   http://localhost:11211/static/test_chat.html
   ```

2. **输入测试需求**
   ```
   设计一个在线商城系统
   ```

3. **点击发送请求**

4. **查看响应**
   - 应该能看到实时流式输出
   - 不再出现 422 错误

---

## 📊 API 数据结构说明

### AgentContextRequest

后端 API 要求的完整数据结构：

```json
{
  "session_id": "session-1234567890",
  "dialogue_history": [
    {
      "role": "user",
      "content": "设计一个在线商城系统"
    }
  ],
  "tool_execution_results": {},
  "session_metadata": {
    "language": "zh"
  },
  "last_updated": null,
  "is_compressed": false,
  "language": "zh",
  "include_metadata": false,
  "buffer_events": false,
  "heartbeat_interval": 30.0
}
```

### 字段说明

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| session_id | string | ✅ | 会话唯一标识符 |
| dialogue_history | array | ✅ | 对话历史，包含消息数组 |
| tool_execution_results | object | ❌ | 工具执行结果 |
| session_metadata | object | ❌ | 会话元数据 |
| language | string | ❌ | 语言设置 (zh/en/ja/es/fr) |
| include_metadata | boolean | ❌ | 是否包含元数据 |
| buffer_events | boolean | ❌ | 是否缓冲事件 |
| heartbeat_interval | float | ❌ | 心跳间隔(秒) |

---

## 🔍 验证修复

打开浏览器开发者工具 (F12):

1. **查看请求**
   - Network 标签
   - 找到 `/api/chat/agent` 请求
   - 状态码应该是 `200 OK` 而不是 `422`

2. **查看响应**
   - 应该能看到 SSE 事件流
   - 事件类型包括: connection, message, tool_call, complete 等

3. **检查控制台**
   - 不应该有错误信息
   - 应该看到事件日志

---

## ⚠️ 注意事项

1. **需要配置 API Key**
   ```powershell
   $env:LLM_API_KEY="sk-your-key"
   $env:LLM_BASE_URL="https://api.openai.com/v1"
   $env:LLM_MODEL="gpt-4"
   ```

2. **服务必须运行**
   - FastAPI 服务应该在 http://localhost:11211
   - 可以通过健康检查验证

3. **浏览器兼容性**
   - 推荐使用 Chrome、Firefox、Edge
   - 需要支持 SSE (Server-Sent Events)

---

## 📝 其他调试信息

### 查看完整日志

在 PowerShell 中可以看到：
```
INFO:     127.0.0.1:xxxxx - "POST /api/chat/agent HTTP/1.1" 200 OK
```

如果看到 `422`，说明还有格式问题。

### 常见错误

1. **缺少必需字段**
   ```
   422 Unprocessable Entity
   ```
   解决: 检查是否包含 session_id 和 dialogue_history

2. **数据类型错误**
   ```
   422 Unprocessable Entity
   ```
   解决: 检查 JSON 格式是否正确

3. **API Key 未配置**
   ```
   500 Internal Server Error
   ```
   解决: 配置环境变量

---

## ✅ 修复完成

前端请求格式已修复，现在应该可以正常工作了！

**刷新页面后重试** 🚀

