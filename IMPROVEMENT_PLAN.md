# GTPlanner 项目改进计划

## 📋 项目当前状态

### ✅ 已完成项
- 核心依赖已安装 (pocketflow, fastapi, openai等)
- 项目结构完整，包含 Agent 架构、CLI、API、MCP 服务
- 支持多语言界面 (中文、英文、日文等)
- 支持流式响应 (SSE)
- 无状态架构设计，支持高并发

### ⚠️ 需要改进项

---

## 🎯 改进计划

### 1. 环境配置优化 (优先级: 高)

#### 1.1 创建快速启动脚本
**目标**: 简化项目启动流程，提供一键启动脚本

**具体措施**:
```bash
# 创建 start_windows.bat
# 创建 start_linux.sh  
# 创建环境检查脚本
```

**收益**: 
- 降低新用户上手难度
- 自动化依赖检查和安装
- 统一的启动入口

#### 1.2 环境变量模板完善
**问题**: 当前 .env.example 缺失
**措施**:
- 创建 `.env.example` 模板文件
- 添加详细注释说明
- 提供不同场景的配置示例 (OpenAI, Azure, 本地模型等)

#### 1.3 Docker 容器化
**目标**: 提供 Docker 部署方案

**具体措施**:
- 优化现有 Dockerfile
- 添加 docker-compose.yml
- 支持开发和生产环境配置

**收益**: 
- 环境一致性
- 快速部署
- 适合生产环境

---

### 2. 依赖管理优化 (优先级: 高)

#### 2.1 解决依赖冲突
**当前问题**:
```
gradio 5.20.0 requires python-multipart>=0.0.18
protobuf 版本冲突
pydantic 版本冲突
```

**措施**:
- 创建独立的虚拟环境
- 使用 requirements.txt 锁定版本
- 添加依赖冲突检测脚本

#### 2.2 Python 版本升级
**当前**: Python 3.10.11
**要求**: Python 3.11+
**措施**:
- 升级 Python 到 3.11+
- 更新所有相关文档

---

### 3. 代码质量提升 (优先级: 中)

#### 3.1 类型注解完善
**目标**: 提高代码可维护性

**措施**:
- 为所有函数添加完整的类型注解
- 使用 mypy 进行类型检查
- 配置 pre-commit hooks

#### 3.2 测试覆盖
**当前**: 仅有基础的 test_basic.py
**目标**: 达到 70%+ 代码覆盖率

**措施**:
- 添加单元测试
- 添加集成测试
- 添加 API 测试
- 配置 pytest + coverage

#### 3.3 代码格式化
**措施**:
- 使用 black 格式化代码
- 使用 isort 整理导入
- 添加 pre-commit 钩子

---

### 4. 文档完善 (优先级: 高)

#### 4.1 中文文档优化
**措施**:
- 补充 API 文档
- 添加架构图 (改进现有 mermaid)
- 添加快速开始示例
- 添加故障排查指南

#### 4.2 开发文档
**目标**: 降低贡献门槛

**措施**:
- 补充开发环境搭建指南
- 添加代码贡献指南
- 补充架构设计文档
- 添加测试指南

#### 4.3 API 文档
**措施**:
- 完善 Swagger/OpenAPI 文档
- 添加示例请求/响应
- 添加错误码说明
- 添加限流说明

---

### 5. 功能增强 (优先级: 中)

#### 5.1 性能监控
**措施**:
- 集成 Prometheus 指标收集
- 添加性能分析工具
- 监控 API 响应时间
- 监控 LLM 调用成本

#### 5.2 错误处理优化
**措施**:
- 统一错误响应格式
- 添加详细错误日志
- 实现错误重试机制
- 添加降级策略

#### 5.3 会话管理增强
**措施**:
- 添加会话过期机制
- 支持会话导出/导入
- 添加会话统计功能
- 优化压缩算法

---

### 6. 安全性提升 (优先级: 中)

#### 6.1 API 安全
**措施**:
- 添加 API 密钥认证
- 实现请求限流
- 添加 CORS 配置优化
- 输入验证增强

#### 6.2 数据安全
**措施**:
- 敏感信息加密存储
- 添加数据备份机制
- 实现数据脱敏
- 添加访问日志

---

### 7. 用户体验优化 (优先级: 中)

#### 7.1 CLI 增强
**措施**:
- 改进输出格式
- 添加进度条
- 支持命令补全
- 添加快捷键

#### 7.2 日志系统
**措施**:
- 结构化日志
- 多级别日志
- 日志轮转
- 日志查询工具

---

## 📊 实施优先级矩阵

| 改进项 | 重要性 | 紧急度 | 优先级 |
|--------|--------|--------|--------|
| 环境配置优化 | 高 | 高 | 🔴 高 ✅ |
| 错误修复 | 高 | 高 | 🔴 高 ✅ |
| 缺失API端点 | 高 | 高 | 🔴 高 ⏳ |
| 依赖冲突解决 | 高 | 中 | 🟡 中高 |
| Python 版本升级 | 高 | 中 | 🟡 中高 |
| 文档完善 | 高 | 中 | 🟡 中高 ✅ |
| 代码质量提升 | 中 | 中 | 🟡 中 |
| 功能增强 | 中 | 低 | 🟢 中低 |
| 性能优化 | 中 | 低 | 🟢 中低 |
| 安全性提升 | 中 | 低 | 🟢 中低 |
| 监控可观测 | 中 | 低 | 🟢 中低 |
| 集成增强 | 低 | 低 | 🟢 低 |

---

## 🚀 快速启动改进方案

### 立即行动项 (本周)

1. **创建启动脚本**
   ```bash
   # 创建 start.bat (Windows)
   # 创建 start.sh (Linux/Mac)
   # 创建 check_env.py (环境检查)
   ```

2. **创建 .env.example**
   - 详细注释
   - 多场景示例

3. **解决 Python 版本**
   - 升级到 3.11+
   - 或调整项目支持 3.10

4. **完善中文文档**
   - 故障排查
   - 常见问题
   - 快速开始

---

## 🐛 8. 错误修复和API改进 (优先级: 高)

### 8.1 AgentContext 数据格式问题
**问题**: Message 类缺少 timestamp 字段导致验证失败
```
ERROR: AgentContext 验证失败: AgentContext 数据格式错误: 'timestamp'
```

**影响**:
- API 调用可能失败
- 前端无法正常获取响应
- 数据处理不一致

**措施**:
- 修复 Message.from_dict() 中 timestamp 字段处理
- 添加默认 timestamp 生成逻辑
- 统一数据格式验证
- 添加向后兼容性处理

### 8.2 工具索引初始化失败
**问题**: 启动时工具索引可能初始化失败
```
WARNING: 应用初始化失败，存在 1 个错误
ERROR: 工具索引不可用
```

**影响**:
- 工具推荐功能不可用
- 需要vector service配置
- 影响用户体验

**措施**:
- 优化工具索引初始化逻辑
- 添加更友好的错误提示
- 提供降级策略（工具索引不可用时仍可用）
- 简化vector service配置

### 8.3 API错误处理不完善
**问题**: 部分错误信息不够详细，难以调试

**措施**:
- 统一错误响应格式
- 添加详细错误代码
- 完善日志记录
- 提供错误恢复机制

### 8.4 FastAPI 过时 API 警告
**问题**: 
```
DeprecationWarning: on_event is deprecated, use lifespan event handlers instead.
```

**措施**:
- 更新到 FastAPI lifespan API
- 改进应用启动/关闭逻辑
- 优化资源管理

---

### 9. 性能和可扩展性优化 (优先级: 中)

### 9.1 会话管理优化
**问题**: 会话数据可能过大，影响性能

**措施**:
- 优化压缩算法
- 实现增量更新
- 添加缓存机制
- 限制会话大小

### 9.2 API响应优化
**措施**:
- 实现结果缓存
- 优化LLM调用频率
- 添加批处理支持
- 改进流式响应性能

### 9.3 资源管理
**措施**:
- 实现连接池
- 优化数据库查询
- 添加限流机制
- 监控资源使用

---

### 10. 安全性增强 (优先级: 中)

### 10.1 API认证
**措施**:
- 添加API key认证
- 实现请求签名
- 添加速率限制
- 实现访问控制

### 10.2 数据安全
**措施**:
- 敏感信息加密
- 实现数据脱敏
- 添加审计日志
- 防止注入攻击

### 10.3 输入验证
**措施**:
- 增强参数验证
- 防止恶意输入
- 添加内容过滤
- 实现请求验证

---

## 🔗 11. 缺失的API端点实现 (优先级: 高)

### 11.1 短期规划API缺失
**文档中提到的API**: `POST /planning/short`

**当前状态**: ❌ 未实现
- 文档中详细描述了该API的功能
- 支持工作流生成和优化
- 支持多语言
- 需要 `requirement`, `previous_flow`, `language`, `user_id` 参数

**影响**:
- 用户无法使用简化的规划API
- 功能不完整
- 文档与实现不一致

**措施**:
- 实现 `/planning/short` 端点
- 实现 `/planning/long` 端点
- 添加请求/响应验证
- 更新API文档

### 11.2 长期规划API缺失
**文档中提到的API**: `POST /planning/long`

**当前状态**: ❌ 未实现
- 文档中描述了生成全面设计文档的功能
- 需要 `requirement`, `previous_flow`, `design_doc` 等参数
- 支持优化现有设计文档

**措施**:
- 实现 `/planning/long` 端点
- 集成设计优化节点
- 添加文件输出功能
- 完善错误处理

### 11.3 非流式聊天API缺失
**文档中提到的API**: `POST /api/chat`

**当前状态**: ❌ 未实现（只有流式版本）
- 某些场景不需要流式响应
- 需要更简单的同步API
- 返回完整结果而不是流

**措施**:
- 实现同步聊天API
- 添加超时控制
- 优化响应格式

### 11.4 会话管理API缺失
**CLI功能未API化**:
- `/sessions` - 列出所有会话
- `/load <id>` - 加载指定会话
- `/delete <id>` - 删除指定会话
- `/stats` - 性能统计

**措施**:
- 实现 `GET /api/sessions` - 获取会话列表
- 实现 `GET /api/sessions/{session_id}` - 获取会话详情
- 实现 `DELETE /api/sessions/{session_id}` - 删除会话
- 实现 `GET /api/sessions/{session_id}/stats` - 获取统计信息

### 11.5 工具查询API缺失
**功能描述**: 查询可用工具列表

**措施**:
- 实现 `GET /api/tools` - 获取所有工具
- 实现 `GET /api/tools/{tool_name}` - 获取工具详情
- 实现 `POST /api/tools/recommend` - 工具推荐
- 添加工具分类和筛选

---

## 🎨 12. 功能特性增强 (优先级: 中)

### 12.1 导出功能增强
**需求**: 支持多种文档格式导出

**当前状态**: ⚠️ 功能不完整
- 缺少导出为 Markdown
- 缺少导出为 PDF
- 缺少导出为 Word
- 缺少批量导出

**措施**:
- 实现 Markdown 导出
- 实现 PDF 导出（使用 reportlab 或 weasyprint）
- 实现 Word 导出（使用 python-docx）
- 添加导出模板系统
- 支持自定义导出格式

### 12.2 批量处理功能
**需求**: 支持批量生成 PRD

**当前状态**: ❌ 未实现

**措施**:
- 实现 `POST /api/batch` 端点
- 支持多个需求同时处理
- 添加进度跟踪
- 实现结果归档
- 添加批量操作统计

### 12.3 历史记录和版本管理
**需求**: 保存和管理历史生成的PRD

**当前状态**: ⚠️ 只有会话管理，缺少版本控制

**措施**:
- 实现PRD版本管理
- 添加变更追踪
- 支持版本对比
- 实现版本回滚
- 添加历史记录查询

### 12.4 协作功能
**需求**: 支持团队协作编辑PRD

**当前状态**: ❌ 完全单机

**措施**:
- 实现共享PRD功能
- 添加评论系统
- 实现协作编辑
- 添加权限管理
- 实现实时同步

### 12.5 模板系统
**需求**: 预定义PRD模板

**当前状态**: ⚠️ 基础模板支持

**措施**:
- 实现模板库
- 添加模板编辑器
- 支持自定义模板
- 实现模板分享
- 添加模板市场

---

## 🔍 13. 监控和可观测性 (优先级: 中)

### 13.1 实时监控
**需求**: 实时监控系统状态

**当前状态**: ⚠️ 只有基础健康检查

**措施**:
- 集成 Prometheus 指标
- 添加 Grafana 仪表板
- 实现告警系统
- 添加性能监控
- 实现资源使用监控

### 13.2 日志系统增强
**需求**: 完善的日志查询和分析

**当前状态**: ⚠️ 只有基础日志

**措施**:
- 实现结构化日志
- 添加日志聚合（ELK Stack）
- 实现日志搜索
- 添加审计日志
- 实现日志分析工具

### 13.3 追踪系统
**需求**: 完整的请求追踪

**当前状态**: ⚠️ 有 Langfuse 但配置复杂

**措施**:
- 简化追踪配置
- 添加 OpenTelemetry 支持
- 实现分布式追踪
- 添加性能分析
- 实现错误追踪

---

## 🧩 14. 集成增强 (优先级: 中)

### 14.1 CI/CD 集成
**需求**: 支持与CI/CD系统集成

**当前状态**: ❌ 未实现

**措施**:
- 实现 GitHub Actions 集成
- 实现 GitLab CI 集成
- 实现 Jenkins 插件
- 添加自动化PRD生成
- 实现任务调度

### 14.2 代码仓库集成
**需求**: 从代码仓库提取信息生成PRD

**当前状态**: ❌ 未实现

**措施**:
- 实现 Git 仓库分析
- 自动提取代码结构
- 生成基于代码的PRD
- 实现反向工程
- 添加架构图生成

### 14.3 Issue管理集成
**需求**: 与Issue管理系统集成

**当前状态**: ❌ 未实现

**措施**:
- 实现 Jira 集成
- 实现 GitHub Issues 集成
- 实现 Trello 集成
- 添加双向同步
- 实现自动化更新

---

## ⚠️ 15. LLM配置检查和友好提示 (优先级: 高)

### 15.1 启动时配置检查
**当前问题**: 
- 服务可以启动但没有 LLM API Key
- 用户只能通过 `new_messages_count: 0` 发现问题
- 没有明确的错误提示

**影响**:
- 用户困惑，不知道为什么没有内容
- 浪费时间调试
- 降低用户体验

**措施**:
- 添加启动时配置检查
- 在缺少配置时显示明确的警告
- 提供配置指南链接
- 前端显示友好的错误信息

### 15.2 LLM API调用失败处理
**当前问题**:
- LLM 调用失败时静默返回空结果
- 没有明确的错误事件

**措施**:
- 捕获 LLM 调用失败
- 发送明确的错误事件
- 前端显示错误信息
- 提供恢复建议

### 15.3 配置指南集成
**措施**:
- 在启动时显示配置链接
- 集成到 API 响应中
- 添加到错误消息中
- 提供快速配置命令

---

## 📝 总结

### 已完成的改进 ✅
1. **环境配置优化** - 降低上手难度
   - 创建了环境检查脚本 `check_env_simple.py`
   - 创建了启动脚本 `start_windows.bat`, `start_linux.sh`
   - 创建了快速开始指南
   - 创建了环境检查工具

2. **LLM配置检查** - 启动时检查并提供友好提示
   - 修改了 `agent/utils/startup_init.py`
   - 添加了 `_check_llm_config()` 函数
   - 添加了明确的配置警告
   - 实现了降级策略（警告不阻止启动）

3. **错误修复** - 修复已知问题
   - 修复了 timestamp 验证错误
   - 修改了 `agent/context_types.py`
   - 添加了 Message.from_dict() 默认值
   - 修复了前端请求格式 `static/test_chat.html`

4. **文档完善** - 提高可维护性
   - 创建了10个详细文档
   - 添加了配置指南
   - 添加了诊断指南

### 待实施的改进 ⏳

#### 高优先级 (必须解决)
1. **缺失的API端点** (11节)
   - 实现10个缺失的端点
   - 文档与实现不一致

2. **工具索引降级策略** (8.2)
   - 允许未配置时继续使用
   - 添加友好提示

3. **FastAPI lifespan更新** (8.4)
   - 修复过时API警告

4. **LLM配置检查** (新增)
   - 启动时检查LLM API Key
   - 提供明确的错误提示

#### 中优先级
5. **依赖冲突解决** (2.1)
6. **Python版本升级** (2.2)
7. **代码质量提升** (3节)
8. **性能优化** (9节)
9. **功能增强** (12节)
10. **监控和集成** (13-14节)

---

## 🎯 当前状态总结

### ✅ 项目可用
- 服务可以启动
- API可以接收请求
- SSE连接正常
- 事件流程完整

### ⚠️ 核心问题
- **缺少LLM API Key配置** - 无法生成实际内容
- **工具索引初始化失败** - 影响功能
- **文档与实现不一致** - 10个API端点未实现
- **FastAPI使用过时API** - 需要更新

### 📊 改进进度
- **已完成**: 4项 (核心修复 + 配置检查)
- **高优先级待实施**: 3项
- **中优先级待实施**: 15项
- **总计改进项**: 22项

建议优先实施：
1. **LLM配置检查** - 添加启动时检查，提供友好错误提示
2. **工具索引降级策略** - 允许在未配置时继续使用
3. **FastAPI lifespan更新** - 修复过时API警告
4. **缺失的API端点** - 实现文档中描述但未实现的API

这些改进能够最大化提升用户体验和功能完整性。

