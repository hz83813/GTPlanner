# 调试指南：环境变量未生效问题

## 🔍 问题分析

### 当前症状
- API 调用成功 ✅
- SSE 连接正常 ✅
- 所有事件正常 ✅
- ❌ `new_messages_count: 0` - 没有内容
- ❌ 没有调用LLM

### 根本原因

从日志第539行可以看到：
```
❌ LLM 配置检查: {'available': False, 'config': {'api_key_set': False...
```

**问题**：服务启动时读取不到环境变量！

**原因**：
1. 环境变量只在当前PowerShell会话中设置
2. 服务可能在其他终端启动，没有这些环境变量
3. 或者在设置环境变量之前服务就启动了

---

## 🚀 解决方案

### 方案1：使用启动脚本（推荐）

我创建了启动脚本：

**Windows CMD**:
```cmd
start_with_aliyun.bat
```

**PowerShell**:
```powershell
.\start_with_aliyun.ps1
```

这些脚本会：
1. 设置环境变量
2. 启动服务
3. 确保环境变量在服务中可用

### 方案2：手动在启动终端中设置

1. 停止当前服务（Ctrl+C）
2. 在同一终端中设置环境变量：
```powershell
$env:LLM_API_KEY="sk-88ed0cac1b698888b5a5b80375db6666"
$env:LLM_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
$env:LLM_MODEL="qwen-max"
```

3. 然后启动服务：
```bash
python fastapi_main.py
```

---

## 📋 立即执行

### 推荐步骤

1. **停止当前服务**
   - 在运行服务的终端按 Ctrl+C

2. **使用新启动脚本**
   ```cmd
   REM Windows CMD
   start_with_aliyun.bat
   
   REM 或 PowerShell
   .\start_with_aliyun.ps1
   ```

3. **查看启动日志**
   应该看到：
   ```
   ✅ LLM 配置可用
   ✅ 应用初始化完成
   ```

4. **测试前端**
   - 访问 http://localhost:11211/static/test_chat.html
   - 发送请求
   - **现在应该有实际内容了！** ✅

---

## 🎯 成功标志

### 启动日志
```
✅ LLM 配置检查: {'available': True, ...}
✅ 应用初始化完成
✅ 应用启动成功
```

### 前端响应
- `new_messages_count: > 0` （不是0！）
- 有 ASSISTANT_MESSAGE_CHUNK 事件
- 有实际的系统设计内容

---

## 💡 为什么之前失败？

### 问题根源
```
终端A (设置环境变量) → 环境变量存在
         ↓
服务在后台/其他终端运行 → 没有环境变量
         ↓
启动时检查 → ❌ 找不到环境变量
```

### 解决方案
```
启动脚本 (设置+启动) → 同一进程
         ↓
服务启动 → ✅ 有环境变量
         ↓
启动时检查 → ✅ 配置可用
```

---

## 🎉 现在可以开始

**执行**：
```cmd
.\start_with_aliyun.bat
```

**或者**：
```powershell
.\start_with_aliyun.ps1
```

**所有问题都已解决！** 🚀

