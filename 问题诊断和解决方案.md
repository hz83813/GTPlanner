# GTPlanner 问题诊断和解决方案

## 🔍 问题诊断

### 当前问题

#### 1. LLM API Key 未配置 ⚠️ 关键问题

**诊断**: 
```bash
LLM_API_KEY: NOT SET
```

**影响**: 
- API连接成功，事件流程正常
- 但无法调用LLM生成实际内容
- 只有心跳和流程事件，没有助手消息内容

**表现**:
- ✅ SSE连接建立成功
- ✅ 收到各种事件
- ✅ 收到心跳
- ❌ 没有实际的PRD内容
- ❌ `new_messages_count: 0`

---

#### 2. 工具索引初始化失败 ⚠️

**诊断**:
```
WARNING: 应用初始化失败，存在 1 个错误
ERROR: - 工具索引不可用
```

**影响**:
- 工具推荐功能不可用
- 但不影响核心功能

---

#### 3. 心跳解析错误 ⚠️

**诊断**:
```
heartbeat: {'timestamp': '...'} (解析错误: Expected property name or '}' in JSON at position 1)
```

**影响**: 
- ⚠️ 最小（不影响核心功能）
- 偶尔出现，不是主要问题

---

## 🚀 解决方案

### 立即解决（必需）

#### 1. 配置 LLM API Key

**Windows PowerShell:**
```powershell
$env:LLM_API_KEY="sk-your-api-key-here"
$env:LLM_BASE_URL="https://api.openai.com/v1"
$env:LLM_MODEL="gpt-4"
```

**重新启动服务:**
```bash
# 停止当前服务 (Ctrl+C)
python fastapi_main.py
```

**验证配置:**
```bash
python check_env_simple.py
# 应该显示 LLM_API_KEY: SET
```

### 长期改进

#### 1. 添加更友好的错误提示

当前问题：没有LLM API Key时，用户看到"数据流结束"但没有明显的错误提示。

**改进**：
- 添加配置检查
- 在缺少配置时发送明确的错误事件
- 前端显示友好的错误信息

#### 2. 实现工具索引降级策略

当前问题：工具索引初始化失败时报错。

**改进**：
- 允许在未配置vector service时继续使用
- 只显示警告，不阻止服务启动
- 提供配置指南

#### 3. 修复心跳格式

当前问题：某些心跳使用单引号而不是双引号。

**改进**：
- 统一JSON格式
- 使用json.dumps()生成所有JSON

---

## 📝 测试步骤

### 1. 配置环境变量

```powershell
# 使用你的真实API Key
$env:LLM_API_KEY="sk-proj-xxxxxxxxxxxxx"
$env:LLM_BASE_URL="https://api.openai.com/v1"
$env:LLM_MODEL="gpt-4"
```

### 2. 验证配置

```bash
python check_env_simple.py
```

应该显示：
```
[3/5] Environment Variables
  [OK] LLM_API_KEY: sk-proj...
  [OK] LLM_BASE_URL: https://...
  [OK] LLM_MODEL: gpt-4
```

### 3. 重新启动服务

```bash
python fastapi_main.py
```

### 4. 测试API

打开 http://localhost:11211/static/test_chat.html

**现在应该能看到**：
- ✅ SSE连接建立
- ✅ 收到各种事件
- ✅ **有实际的PRD内容** ← 关键
- ✅ 助手消息内容显示
- ✅ 完整的生成过程

---

## 🔧 修复建议

### 已实现的修复

1. ✅ 添加timestamp字段到前端请求
2. ✅ 修复Message.from_dict()默认timestamp
3. ✅ 创建环境检查工具
4. ✅ 创建完整的改进计划

### 待实施的修复

1. ⏳ 添加LLM配置检查
2. ⏳ 添加工具索引降级策略
3. ⏳ 修复心跳JSON格式
4. ⏳ 添加更友好的错误提示
5. ⏳ 实现缺失的API端点

---

## 💡 总结

**当前状态**: 
- ✅ API工作正常
- ✅ 事件流正常
- ❌ 无法生成内容（缺少LLM API Key）

**立即需要做的**:
配置 LLM API Key 后，API 就能生成完整的PRD内容了！

**长期改进**: 
已添加到 `IMPROVEMENT_PLAN.md`，包含20+项改进建议。

